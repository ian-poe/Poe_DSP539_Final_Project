---
title: "Ground Fish Analysis around Deepwater Horizen Oil Spill"
author: "Ian Poe"
date: "2025-04-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(sf)
library(mapdata)
library(gridExtra)
```

## Baseline Data

The baseline ground fish data can be found at https://catalog.data.gov/dataset/deepwater-horizon-baseline-dataset-ncei-accession-0150631 which provides data from 1987 to 2010. The data was collected from fisheries reasurch vessels which used twals where used to collect samples of the marine biology of the region. These samples where brought to the boat where there where sorted counted and recorded. The dataset contains 282 variavles with 13248 obserbations.

```{r cars}
dwh = read.csv("../Final_Project/DWH Baseline SEAMAP Groundfish.csv")
dim(dwh)
#colnames(dwh)
```

## Question 1: 

# The Baseline Dataset contains data from before and after the oil spill. Can any significant conclusion be observered within this Dataset?


Start by redefining The data set by the observations of interest (Not Including Specific Species Data). Additional Variables where related which where used in order to find the mean amount of fish sampled relative to how long was spent collecting the sample. An initial Plot of the overall trends for Finfish, Crustations, Other Species, and Total Species where plotted to have a baseline understand of the trends which are being seen.

```{r}
dwh_1 <- dwh %>% 
  select(date_gmt, lat, lon, min_fish, tot_live, fin_catch, crus_catch, othr_catch) %>%
  mutate(date_gmt = mdy(date_gmt)) %>%  # Convert to Date early
  group_by(date_gmt) %>% 
  reframe(
    Sum_min = sum(min_fish),
    M_total_live = sum(tot_live) / Sum_min,
    M_fin = sum(fin_catch) / Sum_min,
    M_crus = sum(crus_catch) / Sum_min,
    M_other = sum(othr_catch) / Sum_min,
    Day = day(date_gmt),
    Month = month(date_gmt),
    Year = year(date_gmt)
  )


dwh_long <- dwh_1 %>%
  pivot_longer(
    cols = c(M_total_live, M_fin, M_crus, M_other), 
    names_to = "Type",
    values_to = "Value" 
  )

# ggplot(dwh_long, aes(x = date_gmt, y = Value, color = Type)) +
#   geom_line(size = 1) +  # Draw lines for each category
#   labs(
#     title = "Seasonal Comparison of Catch Types",
#     x = "Date",
#     y = "Mean Catch",
#     color = "Catch Type"
#   ) +
#   theme_minimal() +
#   scale_color_manual(values = c("M_total_live" = "blue", 
#                                 "M_fin" = "red", 
#                                 "M_crus" = "green", 
#                                 "M_other" = "purple"))

ggplot(dwh_long, aes(x = date_gmt, y = Value, color = Type)) +
  geom_line(size = 1) +  # Draw lines for each category
  geom_smooth(method = "lm", se = FALSE, size = 1, color = "black") +
  facet_wrap(~ Type, scales = "free_y") +  # Create a separate panel for each type
  labs(
    title = "Seasonal Comparison of Catch Types",
    x = "Date",
    y = "Mean Catch",
    color = "Catch Type"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("M_total_live" = "blue", 
                                "M_fin" = "red", 
                                "M_crus" = "green", 
                                "M_other" = "purple"))  # Custom colors for each category
```


The from the overall trends we see that a relatively level trend line is found however there is a apparent sinasoildal trend. As a result to minimize this effect the data was split into two distinct data sets was compare side by side. The data from 2009 (the year before the oil spill) was compared to 2010 (the year of the oil spill). This was done breaking the date down into the day of the year to have both data points plotted side by side. This Allows for additional seasonal trends to be seen. Due to missing Data in 2010 large sections of the data is missing. The 2010 data only contains a partion of the year after the oil spill had occured. To minimize this impart a bar graph is used to visualize the change in mean finfish, mean crustation, mean other, and mean total catch. From this figure slight differences between year can be seen but no certain conclusion can be drawn. 

```{r}
dwh_2010 <- dwh_1 %>%
  filter(Year == 2010 ) %>%
  rename(Date = date_gmt)

dwh_2009 <- dwh_1 %>% 
  filter(Year == 2009) %>% 
  filter(Month == 6 | Month == 7 | Month ==8) %>%
  rename(Date = date_gmt)

make_series <- function(df, value_col, type_label, year_label) {
  df %>%
    select({{ value_col }}, Year, Month, Day) %>%
    mutate(
      DayOfYear = yday(make_date(Year, Month, Day)),
      Value = {{ value_col }},
      Type = type_label,
      Year = year_label
    ) %>%
    select(DayOfYear, Value, Type, Year)
}

# Combine all lines
all_lines <- bind_rows(
  make_series(dwh_2009, M_fin, "Finfish", 2009),
  make_series(dwh_2010, M_fin, "Finfish", 2010),
  
  make_series(dwh_2009, M_crus, "Crustaceans", 2009),
  make_series(dwh_2010, M_crus, "Crustaceans", 2010),
  
  make_series(dwh_2009, M_other, "Other", 2009),
  make_series(dwh_2010, M_other, "Other", 2010),
  
  make_series(dwh_2009, M_total_live, "Total", 2009),
  make_series(dwh_2010, M_total_live, "Total", 2010)
)


library(ggplot2)

# ggplot(all_lines, aes(x = DayOfYear, y = Value, color = as.factor(Year), linetype = Type)) +
#   geom_line(size = 1) +
#   labs(
#     title = "Seasonal Catch Comparison (2009 vs 2010)",
#     x = "Day of Year",
#     y = "Mean Catch",
#     color = "Year",
#     linetype = "Catch Type"
#   ) +
#   theme_minimal() +
#   scale_color_manual(values = c("2009" = "blue", "2010" = "red"))
# 
# 
# ggplot(all_lines, aes(x = DayOfYear, y = Value, color = as.factor(Year))) +
#   geom_line(size = 1) +
#   facet_wrap(~ Type, scales = "free_y") +
#   labs(
#     title = "Seasonal Catch Comparison by Type (2009 vs 2010)",
#     x = "Day of Year",
#     y = "Mean Catch",
#     color = "Year"
#   ) +
#   theme_minimal()

ggplot(all_lines, aes(x = DayOfYear, y = Value, fill = as.factor(Year))) +
  geom_col(position = "dodge") +
  facet_wrap(~ Type, scales = "free_y") +
  labs(
    title = "Seasonal Catch Comparison by Type (2009 vs 2010)",
    x = "Day of Year",
    y = "Mean Catch",
    fill = "Year"
  ) +
  theme_minimal()

```


In order to draw a more conclusive result two linear model was fitted to the data. The first linear model was a full model which include a verity of variable in order to determine significance. This model used total catch as a response with the longitude, latitude, minutes fished, depth, time of day, mesh size, tows, vessel speed, month, year, and is_2010 was variables. By adding a binary dummy variable for the 2010 data we can see if this data is significantly different that the other years. From this linear model a low r-squared was found which means the model does not fit the data very well. However, 8 of the explanatory variables where found to be significant. To ensure the variable is_2010 was not being influenced by and strong associations it other explanatory variables a second linear model was fitted using total catch as the responce variable and only is_2010 as the explanatory. This linear model also concluded significance of the year 2010. 

```{r}
#Statistical Test
dwh_3 <- dwh %>% 
  select(date_gmt, time_gmt, lat, lon, min_fish, tot_live, fin_catch, crus_catch, othr_catch, depth, TOD, GEAR_SIZE, GEAR_TYPE, MESH_SIZE, tows, vessel_spd) %>%
  mutate(
    date_gmt = mdy(date_gmt),  # Convert to date format
    day = day(date_gmt),       # Extract day
    month = month(date_gmt),   # Extract month
    year = year(date_gmt),     # Extract year
    is_2010 = ifelse(year == 2010, 1, 0)  # Binary flag for 2010
  )

#Linear Model of M_total_live 

#Binary Variable of 2010 Added to Check Significance
lm_M_Total = lm(tot_live~lat+lon+min_fish+as.numeric(depth)+TOD+MESH_SIZE+tows+vessel_spd+month+year+is_2010, data = dwh_3)
summary(lm_M_Total)

lm_2010 = lm(tot_live ~ is_2010, data = dwh_3)
summary(lm_2010)

```


## Question 2:

# Are we able to compare the data from 2010 to the data in 2010 or other years?

To answer this question we want to ensure that the data is being sampled from the same areas, with the same distribution to the variables. 

First The location will be viewed the code below shows the plotted locations for all of the surveyed locations. A map of the gulf is created and points in red of all surveyed locations are plotted. A desnity plot is generated over these points to see the areas of importance. 

```{r}
#Trawl Location over the entire Data set

dwh_2 <- dwh %>% 
  select(date_gmt, lat, lon, min_fish, tot_live, fin_catch, crus_catch, othr_catch,depth,TOD,GEAR_SIZE,GEAR_TYPE,MESH_SIZE,tows,vessel_spd) %>%
  mutate(date_gmt = mdy(date_gmt))

trawl_loc = cbind(dwh_2$lon,dwh_2$lat)
trawl_sp = SpatialPoints(trawl_loc)
trawl_spdf = SpatialPointsDataFrame(trawl_loc,dwh_2)

coords_df <- as.data.frame(trawl_spdf)

xlim <- c(-98, -81)  # Longitude limits
ylim <- c(18, 31)    # Latitude limits

ggplot() +
  borders("world", xlim = xlim, ylim = ylim, fill = "lightgray", colour = "black") +
  borders("usa", colour = "black") +
  borders("state", colour = "darkgray") +
  geom_point(data = dwh_2, aes(x = lon, y = lat), color = "red", size = 1.5) + # Add points
  stat_density2d(data = dwh_2, aes(x = lon, y = lat, fill = ..level..), geom = "polygon", alpha = 0.4) + # Density plot
  scale_fill_viridis_c() +
  labs(title = "Gulf of Mexico with Density Plot", x = "Longitude", y = "Latitude") +
  coord_cartesian(xlim = xlim, ylim = ylim) +  # Restrict the view to the Gulf
  theme_minimal()
```

Now we want to check the data from 2009 and 2010 in order to determine if these years the data is being sampled from simulate areas. If the data is not being sampled from the same areas then it will be hard to draw any conclusion for the data as sampling error and bais could affect the results of the data. A function was created to take the initial data set and plot any years specific coordinates on the map so it could be compared. An additional black dote was created to show where the oil spill had occurred. Comparing 2009 to 2010 we see that the 2010 data is grouped only in the northwest portion of the gulf while the 2009 data collected samples from the entire north (boardering the US) portion of the gulf. From these figures we should conclude that this data cannot be used to determine a difference in data for the 2010 data. 

```{r}
#Function for location in a year

location_per_year = function(data,year){
  data2= data %>% filter(year(date_gmt) == year)
  
  trawl_loc = cbind(data2$lon,data2$lat)
  trawl_sp = SpatialPoints(trawl_loc)
  trawl_spdf = SpatialPointsDataFrame(trawl_loc,data2)
  coords_df <- as.data.frame(trawl_spdf)
  
  xlim <- c(-98, -81)  # Longitude limits
  ylim <- c(18, 31)    # Latitude limits
  
  ggplot() +
    borders("world", xlim = xlim, ylim = ylim, fill = "lightgray", colour = "black") +
    borders("usa", colour = "black") +
    borders("state", colour = "darkgray") +
    geom_point(data = data2, aes(x = lon, y = lat), color = "red", size = 1.5) + # Add points
    geom_point(aes(x = -88.37, y = 28.74), color = "black", size = 4) +
    stat_density2d(data = data2, aes(x = lon, y = lat, fill = ..level..), geom = "polygon", alpha = 0.4) + # Density plot
    scale_fill_viridis_c() +
    labs(title = paste("Gulf of Mexico with Density Plot ", year), x = "Longitude", y = "Latitude") +
    coord_cartesian(xlim = xlim, ylim = ylim) +  # Restrict the view to the Gulf
    theme_minimal()
}

location_per_year(dwh_2,2009)
location_per_year(dwh_2,2010)

```

Next the distribution of depth is checked from the data drom 2009 to 2010. A function was created which uses the initial data and two year inputes to compare the distribution of depth of the samples of the two years. In a ideal world these distributions should be the same or approximately the same. Plotting 2009 to 2010 we can see the 2009 data was sampled more from a 500-2000 ft depth while 2010 had a larger proportion from 2000 to 4000 ft.

```{r}
depth_per_year_density = function(data, year1, year2){

  # Filter data for the selected years
  data1 = data %>% filter(year(date_gmt) == year1)
  data2 = data %>% filter(year(date_gmt) == year2)
  
  # Create the dataframe with correct lengths
  df = data.frame(
    values = as.numeric(c(data1$depth, data2$depth)),  # Ensure numeric values
    group = factor(rep(c(year1, year2), c(length(data1$depth), length(data2$depth))))
  )
  
  # Generate the density plot
  ggplot(df, aes(x = values, fill = group, color = group)) +
    geom_density(alpha = 0.5, linewidth = 1) +  # Smoothed density curves
    scale_fill_manual(values = c("blue", "red")) +
    scale_color_manual(values = c("blue", "red")) +  # Match density lines to fill colors
    labs(title = paste("Comparison of Depth Distributions:", year1, "vs.", year2),
         x = "Depth",
         y = "Density") +
    theme_minimal()
}

# Call the function
depth_per_year_density(dwh_2, 2009, 2010)
```

A density plot of speed was then created in order to see how the distributions of speed differ from year to year. Again ideally these distributions will be similar. A function was created which uses the same imputes (data, year1, and year2). Comparing 2009 to 2010 we see the data from 2009 was more spread out with a peak of about 2.6. We see 2010 has very little variation with a large spike around 2.7 and very little spreat. 

```{r}
speed_per_year_density = function(data, year1, year2){

  # Filter data for the selected years and add a year column
  data1 = data %>% filter(year(date_gmt) == year1) %>% mutate(year = as.factor(year1))
  data2 = data %>% filter(year(date_gmt) == year2) %>% mutate(year = as.factor(year2))
  
  # Combine datasets
  df = bind_rows(data1, data2)
  
  # Generate density plot for vessel speed comparison
  ggplot(df, aes(x = vessel_spd, fill = year, color = year)) +
    geom_density(alpha = 0.5, linewidth = 1) +  # Smoothed density curves
    scale_fill_manual(values = c("blue", "red")) +
    scale_color_manual(values = c("blue", "red")) +  # Match density lines to fill colors
    xlim(2, 4) +  # Adjusted range for better viewing
    labs(title = paste("Vessel Speed Density Comparison:", year1, "vs.", year2),
         x = "Speed",
         y = "Density") +
    theme_minimal()
}

# Call the function
speed_per_year_density(dwh_2, 2009, 2010)
```

Through the inconsistency in the maps of surveyed locations, differences in the density plots of both the depth and the speed the samples where collected the results from the linear regression should be viewed very skeptically as the sample from 2010 does a poor job at representing the true region being surveyed.  

## Using this dataset as a Baseline; Can We Identify at Risk Fish

I want to create a function where I can view how a species population (mean_number_caught) changes from a respective data. For this project I want to identify the five species which increased and decreased the most. A reference year is used as a baseline for the starting position of the species. Below the Year 2000 is used. Then we want to compare the greatest change to the mean of the data from the last year. Above we found that 2010 should not be used as a good representation of the year of data as a result we are excluding this year and using 2009 as the end point for the data. The function requires the original data, a reference year, and the number of observations for both species increasing and decreasing. 

```{r}
Species_Greatest_Change <- function(data, ref_year, n) {
  
  data <- data %>%
    filter(year >= ref_year & year != 2010) %>%
    group_by(year) %>%
    summarise(across(starts_with("N_"), mean, na.rm = TRUE))
  
  # Identify species columns
  species_cols <- names(data)[grepl("^N_", names(data))]
  
  # Initialize species change dataframe
  species_matrix <- data.frame(Species = species_cols, Change = numeric(length(species_cols)), Trend = character(length(species_cols)))
  
  # Calculate change between first and last recorded year
  for (i in seq_along(species_cols)) {
    first_year_value <- data[[species_cols[i]]][1]
    last_year_value <- data[[species_cols[i]]][nrow(data)]  
    
    species_matrix$Change[i] <- last_year_value - first_year_value
    
    species_matrix$Trend[i] <- ifelse(species_matrix$Change[i] > 0, "Increasing", "Decreasing")
  }
  
  # Get top n increasing
  top_increasing <- species_matrix %>%
    filter(Trend == "Increasing") %>%
    arrange(desc(Change)) %>%
    head(n)
  
  # Get top n decreasing
  top_decreasing <- species_matrix %>%
    filter(Trend == "Decreasing") %>%
    arrange(Change) %>%  
    head(n)
  
  return(list(Top_Increasing = top_increasing, Top_Decreasing = top_decreasing))
}

# Example usage
#Species_Greatest_Change(dwh, 2000, 5) 
species = Species_Greatest_Change(dwh, 2000, 5) 
species_increased <- sub("^N_", "", species$Top_Increasing$Species)  
species_increased <- gsub("_", " ", species_increased)
species_decreased <- sub("^N_", "", species$Top_Decreasing$Species)  
species_decreased <- gsub("_", " ", species_decreased)
print(species_increased)
print(species_decreased)
```




