---
title: "Ground Fish Analysis around Deepwater Horizen Oil Spill"
author: "Ian Poe"
date: "2025-04-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Import Library for Analysis
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(sf)
library(mapdata)
library(gridExtra)
library(sp)
```

## Baseline Data

The baseline ground fish data can be found at https://catalog.data.gov/dataset/deepwater-horizon-baseline-dataset-ncei-accession-0150631 which provides data from 1987 to 2010. The data was collected from fisheries reasurch vessels which used twals where used to collect samples of the marine biology of the region. These samples where brought to the boat where there where sorted counted and recorded. The dataset contains 282 variavles with 13248 obserbations.

```{r cars}
dwh = read.csv("../Final_Project/DWH Baseline SEAMAP Groundfish.csv")  #Import Trawling Data set
dim(dwh)                                                               #View the dimensions of the Trawling Data set
#colnames(dwh)                                                         # Obtain colomn names of each variable
```

## Question 1: 

# The Baseline Dataset contains data from before and after the oil spill. Can any significant conclusion be observered within this Dataset?


Start by redefining The data set by the observations of interest (Not Including Specific Species Data). Additional Variables where related which where used in order to find the mean amount of fish sampled relative to how long was spent collecting the sample. An initial Plot of the overall trends for Finfish, Crustations, Other Species, and Total Species where plotted to have a baseline understand of the trends which are being seen.

```{r}
dwh_1 <- dwh %>%                                                                          #Using the Trawling Data
  select(date_gmt, lat, lon, min_fish, tot_live, fin_catch, crus_catch, othr_catch) %>%   #Select specific variables from original data set
  mutate(date_gmt = mdy(date_gmt)) %>%                                                    #Specify Date For Format
  group_by(date_gmt) %>%                                                                  #Group data by unique day to ensure one point for any given day
  reframe(                                                                                #Creates New Variables
    Sum_min = sum(min_fish),                                                              #Total Time of Trawling per Day
    M_total_live = sum(tot_live) / Sum_min,                                               #Mean amount of total live caught per day
    M_fin = sum(fin_catch) / Sum_min,                                                     #Mean amount of fin fish caught per day
    M_crus = sum(crus_catch) / Sum_min,                                                   #Mean amount of crustations caught per day
    M_other = sum(othr_catch) / Sum_min,                                                  #Mean amount of other species caught per day
    Day = day(date_gmt),                                                                  #Day of the Month of Sample
    Month = month(date_gmt),                                                              #Month of the Year of Sample
    Year = year(date_gmt)                                                                 #Year of the Sample
  )


#Use Pivot Longer to Combine All Mean Values into a Value column with a Type Column added for M_total_live, M_fin, M_crus, M_other

dwh_long <- dwh_1 %>% 
  pivot_longer(
    cols = c(M_total_live, M_fin, M_crus, M_other), 
    names_to = "Type",
    values_to = "Value" 
  )

#Graph the Trend over time on one plot with four separate lines.

ggplot(dwh_long, aes(x = date_gmt, y = Value, color = Type)) +                            #Use ggplot function with date as the X and Value as the Y and color as type
  geom_line(size = 1) +                                                                   #Specify a line graph and draw lines for each category
  labs(                                                                                   #X,Y, and Title Labels for the Graph
    title = "Seasonal Comparison of Catch Types",
    x = "Date",
    y = "Mean Catch",
    color = "Catch Type"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("M_total_live" = "blue",                                  #Specify Colors of the Type for the Graph
                                "M_fin" = "red",
                                "M_crus" = "green",
                                "M_other" = "purple"))

ggplot(dwh_long, aes(x = date_gmt, y = Value, color = Type)) +                            #Use ggplot function with date as the X and Value as the Y and color as type
  geom_line(size = 1) +                                                                   #Specify Line Graph
  geom_smooth(method = "lm", se = FALSE, size = 1, color = "black") +                     #Add a smoothed trend line to the plot
  facet_wrap(~ Type, scales = "free_y") +                                                 #Create a separate panel for each type 
  labs(                                                                                   #X,Y, and Title Labels for the Graph
    title = "Seasonal Comparison of Catch Types",
    x = "Date",
    y = "Mean Catch",
    color = "Catch Type"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("M_total_live" = "blue",                                  #Specify Colors of each Graph
                                "M_fin" = "red", 
                                "M_crus" = "green", 
                                "M_other" = "purple"))  
```


The from the overall trends we see that a relatively level trend line is found however there is a apparent sinasoildal trend. As a result to minimize this effect the data was split into two distinct data sets was compare side by side. The data from 2009 (the year before the oil spill) was compared to 2010 (the year of the oil spill). This was done breaking the date down into the day of the year to have both data points plotted side by side. This Allows for additional seasonal trends to be seen. Due to missing Data in 2010 large sections of the data is missing. The 2010 data only contains a portion of the year after the oil spill had occurred. To minimize this impart a bar graph is used to visualize the change in mean finfish, mean crustation, mean other, and mean total catch. From this figure slight differences between year can be seen but no certain conclusion can be drawn. 

```{r}
dwh_2010 <- dwh_1 %>%                                                                                     #Creates data set for observations only 2010 (Using DWH1 Defined Above)
  filter(Year == 2010 ) %>%                                                                               #Filter by 2010
  rename(Date = date_gmt)                                                                                 #Rename variable "date_gmt" to "Date"

dwh_2009 <- dwh_1 %>%                                                                                     #Creates data set for observations only 2009 (Using DWH1 Defined Above)
  filter(Year == 2009) %>%                                                                                #Filter by year = 2010
  filter(Month == 6 | Month == 7 | Month ==8) %>%                                                         #Filter by month = 6,7,8 to match with the partial data from 2010
  rename(Date = date_gmt)                                                                                 #Rename variable "date_gmt" to "Date"

make_series <- function(df, value_col, type_label, year_label) {                                          #Creating of A function "make_series" which creates a line for Value over days in a year
  df %>%                                                                                                  #df input variable
    select({{ value_col }}, Year, Month, Day) %>%                                                         #Select Variables from Data set (Year,Month,Day) and value_col from input
    mutate(                                                                                               #create new variables
      DayOfYear = yday(make_date(Year, Month, Day)),                                                      #day of the year (Range From 1:365)
      Value = {{ value_col }},                                                                            #Value which is the Mean Total Alive of the Designated Species
      Type = type_label,                                                                                  #Type Label for Graph
      Year = year_label                                                                                   #Year Label for Graph
    ) %>%
    select(DayOfYear, Value, Type, Year)                                                                  #Keep Specific Variables
}

# Combine all lines
all_lines <- bind_rows(                                                                                   #Binding all rows together to plot all lines together
  make_series(dwh_2009, M_fin, "Finfish", 2009),                                                          #"make_series" for 2009 Finfish
  make_series(dwh_2010, M_fin, "Finfish", 2010),                                                          #"make_series" for 2010 Finfish
  
  make_series(dwh_2009, M_crus, "Crustaceans", 2009),                                                     #"make_series" for 2009 Crustaceans
  make_series(dwh_2010, M_crus, "Crustaceans", 2010),                                                     #"make_series" for 2010 Crustaceans
  
  make_series(dwh_2009, M_other, "Other", 2009),                                                          #"make_series" for 2009 Other
  make_series(dwh_2010, M_other, "Other", 2010),                                                          #"make_series" for 2010 Other
  
  make_series(dwh_2009, M_total_live, "Total", 2009),                                                     #"make_series" for 2009 Total
  make_series(dwh_2010, M_total_live, "Total", 2010)                                                      #"make_series" for 2010 Total
)

#Line graph of All 8 Lines on a single plot with Mean Catch on the Y and Day of the Year on the X

ggplot(all_lines, aes(x = DayOfYear, y = Value, color = as.factor(Year), linetype = Type)) +             #Use ggplot function with day_of_year as the X and Value as the Y and linetype as type
  geom_line(size = 1) +                                                                                  #Use Line Graph
  labs(                                                                                                  #Labels for X,Y,Title, and Key
    title = "Seasonal Catch Comparison (2009 vs 2010)",
    x = "Day of Year",
    y = "Mean Catch",
    color = "Year",
    linetype = "Catch Type"
  ) +
  theme_minimal() +
  scale_color_manual(values = c("2009" = "blue", "2010" = "red"))                                        #Change Colors of Lines By Year


#Plot line graphs of the two years next to each other separated by Type

ggplot(all_lines, aes(x = DayOfYear, y = Value, color = as.factor(Year))) +                              #Use ggplot function with day_of_year as the X and Value as the Y and color as Year
  geom_line(size = 1) +                                                                                  #Use Line Graph
  facet_wrap(~ Type, scales = "free_y") +                                                                #Using Facet_wrap separate data into 4 graphs (one for each type)
  labs(                                                                                                  #Labels for X,Y,Title, and Key
    title = "Seasonal Catch Comparison by Type (2009 vs 2010)",
    x = "Day of Year",
    y = "Mean Catch",
    color = "Year"
  ) +
  theme_minimal()

#Creates A Vertical Bar Graph to Better Visualize Missing Data

ggplot(all_lines, aes(x = DayOfYear, y = Value, fill = as.factor(Year))) +                               #Use ggplot function with day_of_year as the X and Value as the Y and color as Year
  geom_col(position = "dodge") +                                                                         #Creates a Vertical Bar Graph
  facet_wrap(~ Type, scales = "free_y") +                                                                #Using Facet_wrap separate data into 4 graphs (one for each type)
  labs(                                                                                                  #Labels for X,Y,Title, and Key
    title = "Seasonal Catch Comparison by Type (2009 vs 2010)",
    x = "Day of Year",
    y = "Mean Catch",
    fill = "Year"
  ) +
  theme_minimal()

```


In order to draw a more conclusive result two linear model was fitted to the data. The first linear model was a full model which include a verity of variable in order to determine significance. This model used total catch as a response with the longitude, latitude, minutes fished, depth, time of day, mesh size, tows, vessel speed, month, year, and is_2010 was variables. By adding a binary dummy variable for the 2010 data we can see if this data is significantly different that the other years. From this linear model a low r-squared was found which means the model does not fit the data very well. However, 8 of the explanatory variables where found to be significant. To ensure the variable is_2010 was not being influenced by and strong associations it other explanatory variables a second linear model was fitted using total catch as the responce variable and only is_2010 as the explanatory. This linear model also concluded significance of the year 2010. 

```{r}
#Statistical Test
dwh_3 <- dwh %>%                                                                                                                                                  #Original Data With All Relevant Variables
  select(date_gmt, time_gmt, lat, lon, min_fish, tot_live, fin_catch, crus_catch, othr_catch, depth, TOD, GEAR_SIZE, GEAR_TYPE, MESH_SIZE, tows, vessel_spd) %>%  #Relevant Variables
  mutate(                                                                                                                                                         #New Variables
    date_gmt = mdy(date_gmt),                                                                                                                                     # Convert to date format
    day = day(date_gmt),                                                                                                                                          # Extract day
    month = month(date_gmt),                                                                                                                                      # Extract month
    year = year(date_gmt),                                                                                                                                        # Extract year
    is_2010 = ifelse(year == 2010, 1, 0)                                                                                                                          # Binary flag for 2010
  )

#Linear Model of M_total_live 

#Binary Variable of 2010 Added to Check Significance
lm_M_Total = lm(tot_live~lat+lon+min_fish+as.numeric(depth)+TOD+MESH_SIZE+tows+vessel_spd+month+year+is_2010, data = dwh_3)                                      # Fit Linear Model With selected Variables
summary(lm_M_Total)                                                                                                                                              # View Results of Linear Model

lm_2010 = lm(tot_live ~ is_2010, data = dwh_3)                                                                                                                   # Fit lm with only binary is_2010 variable
summary(lm_2010)                                                                                                                                                 # View Results of lm with binary flag only

```


## Question 2:

# Are we able to compare the data from 2010 to the data in 2010 or other years?

To answer this question we want to ensure that the data is being sampled from the same areas, with the same distribution to the variables. 

First The location will be viewed the code below shows the plotted locations for all of the surveyed locations. A map of the gulf is created and points in red of all surveyed locations are plotted. A density plot is generated over these points to see the areas of importance. 

```{r}
#Trawl Location over the entire Data set

dwh_2 <- dwh %>%                                                                                                                                   #Filter Data set for Question 2
  select(date_gmt, lat, lon, min_fish, tot_live, fin_catch, crus_catch, othr_catch,depth,TOD,GEAR_SIZE,GEAR_TYPE,MESH_SIZE,tows,vessel_spd) %>%    #Select Variables of Interest
  mutate(date_gmt = mdy(date_gmt))                                                                                                                 #Specify date format for "date_gmt"

trawl_loc = cbind(dwh_2$lon,dwh_2$lat)                                                                                                             #bind geographical coordinates together
trawl_sp = SpatialPoints(trawl_loc)                                                                                                                #Create Spatial Points with Coordinates
trawl_spdf = SpatialPointsDataFrame(trawl_loc,dwh_2)                                                                                               #Update data frame to become a Spatial Point Data frame 

coords_df <- as.data.frame(trawl_spdf) 

xlim <- c(-98, -81)                                                                                                                                # Longitude limits for Gulf of Mexico
ylim <- c(18, 31)                                                                                                                                  # Latitude limits for Gulf of Mexico

#Create a Map of the Gulf with all the points plotted on the map and a density plot overlayed

ggplot() +                                                                                                                                         #map is created using ggplot
  borders("world", xlim = xlim, ylim = ylim, fill = "lightgray", colour = "black") +                                                               #Using a world map the area is selected by long and lat limits
  borders("usa", colour = "black") +                                                                                                               #Boarder of the USA, Mexico and other Gulf Country's in Black
  borders("state", colour = "darkgray") +                                                                                                          #USA State Boarders in Gray
  geom_point(data = dwh_2, aes(x = lon, y = lat), color = "red", size = 1.5) +                                                                     # Add points for trawl locations
  stat_density2d(data = dwh_2, aes(x = lon, y = lat, fill = ..level..), geom = "polygon", alpha = 0.4) +                                           # Add Density plot for location of trawling
  scale_fill_viridis_c() +
  labs(title = "Gulf of Mexico with Density Plot", x = "Longitude", y = "Latitude") +                                                              #X and Y Axis Labels and Title
  coord_cartesian(xlim = xlim, ylim = ylim) +                                                                                                      # Restrict the view to the Gulf
  theme_minimal()
```

Now we want to check the data from 2009 and 2010 in order to determine if these years the data is being sampled from simulate areas. If the data is not being sampled from the same areas then it will be hard to draw any conclusion for the data as sampling error and bais could affect the results of the data. A function was created to take the initial data set and plot any years specific coordinates on the map so it could be compared. An additional black dote was created to show where the oil spill had occurred. Comparing 2009 to 2010 we see that the 2010 data is grouped only in the northwest portion of the gulf while the 2009 data collected samples from the entire north (boardering the US) portion of the gulf. From these figures we should conclude that this data cannot be used to determine a difference in data for the 2010 data. 

```{r}
#Function for location in a year

location_per_year = function(data,year){                                                                   #Create Function "location_per_year" to plot trawl locations on a map for any given year 
  data2= data %>% filter(year(date_gmt) == year)                                                           #Filter the inputted data set by the inputted year of interest
  
  trawl_loc = cbind(data2$lon,data2$lat)                                                                   #bind geographical coordinates together
  trawl_sp = SpatialPoints(trawl_loc)                                                                      #Create Spatial Points with Coordinates
  trawl_spdf = SpatialPointsDataFrame(trawl_loc,data2)                                                     #Update data frame to become a Spatial Point Data frame 
  coords_df <- as.data.frame(trawl_spdf)
  
  xlim <- c(-98, -81)                                                                                      #  Longitude limits for Gulf of Mexico
  ylim <- c(18, 31)                                                                                        # Latitude limits for Gulf of Mexico
  
  ggplot() +                                                                                               #map is created using ggplot
    borders("world", xlim = xlim, ylim = ylim, fill = "lightgray", colour = "black") +                     #Using a world map the area is selected by long and lat limits
    borders("usa", colour = "black") +                                                                     #Boarder of the USA, Mexico and other Gulf Country's in Black
    borders("state", colour = "darkgray") +                                                                #USA State Boarders in Gray
    geom_point(data = data2, aes(x = lon, y = lat), color = "red", size = 1.5) +                           #Add points for trawl locations
    geom_point(aes(x = -88.37, y = 28.74), color = "black", size = 4) +                                    #Add the Location of the DWH Drill Site as a Larger Point in Black for Reference
    stat_density2d(data = data2, aes(x = lon, y = lat, fill = ..level..), geom = "polygon", alpha = 0.4) + #Add Density plot for location of trawling
    scale_fill_viridis_c() +
    labs(title = paste("Gulf of Mexico with Density Plot ", year), x = "Longitude", y = "Latitude") +      #X and Y Axis Labels and Title
    coord_cartesian(xlim = xlim, ylim = ylim) +                                                            # Restrict the view to the Gulf
    theme_minimal()
}

location_per_year(dwh_2,2009)                                                                              #Create a map for the 2009 trawling data
location_per_year(dwh_2,2010)                                                                              #Create a map for the 2010 trawling data

```

Next the distribution of depth is checked from the data drom 2009 to 2010. A function was created which uses the initial data and two year inputes to compare the distribution of depth of the samples of the two years. In a ideal world these distributions should be the same or approximately the same. Plotting 2009 to 2010 we can see the 2009 data was sampled more from a 500-2000 ft depth while 2010 had a larger proportion from 2000 to 4000 ft.

```{r}
depth_per_year_density = function(data, year1, year2){                                      #Create Function "depth_per_year_density" to Overlay the distribution density of Depth for two chosen years 

  # Filter data for the selected years
  data1 = data %>% filter(year(date_gmt) == year1)                                          #Data set filtered to only include year1 observations 
  data2 = data %>% filter(year(date_gmt) == year2)                                          #Data set filtered to only include year2 observations 
  
  # Create the dataframe with correct lengths
  df = data.frame(                                                                          #Creates a data frame for Values and Groups
    values = as.numeric(c(data1$depth, data2$depth)),                                       # Ensure numeric values for depth values
    group = factor(rep(c(year1, year2), c(length(data1$depth), length(data2$depth))))       # Replicates year1 for the length of year1 depth and year2 for the length of year2 depths
  )
  
  # Generate the density plot
  ggplot(df, aes(x = values, fill = group, color = group)) +                                # ggplot is used specifying variables as values (depth) on the X 
    geom_density(alpha = 0.5, linewidth = 1) +                                              # Smoothed density curves are added for values (depth)
    scale_fill_manual(values = c("blue", "red")) +                                          #Fill interior of Line with Specified color (red or blue)
    scale_color_manual(values = c("blue", "red")) +  #                                      #Match density lines to fill colors
    labs(title = paste("Comparison of Depth Distributions:", year1, "vs.", year2),          #Title which changes with inpuyted years, X and Y axis labels
         x = "Depth",
         y = "Density") +
    theme_minimal()
}

# Call the function
depth_per_year_density(dwh_2, 2009, 2010)                                                  #Create Density Plot for Depth Comparing 2009 data to 2010
```

A density plot of speed was then created in order to see how the distributions of speed differ from year to year. Again ideally these distributions will be similar. A function was created which uses the same imputes (data, year1, and year2). Comparing 2009 to 2010 we see the data from 2009 was more spread out with a peak of about 2.6. We see 2010 has very little variation with a large spike around 2.7 and very little spreat. 

```{r}
speed_per_year_density = function(data, year1, year2){                                     #Create Function "speed_per_year_density" to Overlay the distribution density of Depth for two chosen years 

  # Filter data for the selected years and add a year column
  data1 = data %>% filter(year(date_gmt) == year1) %>% mutate(year = as.factor(year1))     #Data set filtered to only include year1 observations 
  data2 = data %>% filter(year(date_gmt) == year2) %>% mutate(year = as.factor(year2))     #Data set filtered to only include year2 observations 
  
  # Combine datasets
  df = bind_rows(data1, data2)                                                             #Bind Rows of the filtered data for the selected two years
  
  # Generate density plot for vessel speed comparison
  ggplot(df, aes(x = vessel_spd, fill = year, color = year)) +                             # ggplot is used specifying variables as vessell_spd on the X and color as year
    geom_density(alpha = 0.5, linewidth = 1) +                                             # Smoothed density curves are added for Speed
    scale_fill_manual(values = c("blue", "red")) +                                         #Fill interior of Line with Specified color (red or blue)
    scale_color_manual(values = c("blue", "red")) +                                        # Match density lines to fill colors
    xlim(2, 4) +                                                                           # Adjusted range for better viewing
    labs(title = paste("Vessel Speed Density Comparison:", year1, "vs.", year2),           #Title which changes with inputted years, X and Y axis labels
         x = "Speed",
         y = "Density") +
    theme_minimal()
}

# Call the function
speed_per_year_density(dwh_2, 2009, 2010)                                                  #Create Density Plot for Speed Comparing 2009 data to 2010                                            
```

Through the inconsistency in the maps of surveyed locations, differences in the density plots of both the depth and the speed the samples where collected the results from the linear regression should be viewed very skeptically as the sample from 2010 does a poor job at representing the true region being surveyed.  

## Question 3.1:

# Using this dataset as a Baseline; Can We Identify at Risk Fish

I want to create a function where I can view how a species population (mean_number_caught) changes from a respective data. For this project I want to identify the five species which increased and decreased the most. A reference year is used as a baseline for the starting position of the species. Below the Year 2000 is used. Then we want to compare the greatest change to the mean of the data from the last year. Above we found that 2010 should not be used as a good representation of the year of data as a result we are excluding this year and using 2009 as the end point for the data. The function requires the original data, a reference year, and the number of observations for both species increasing and decreasing. 

```{r}
#Function to Identify Species of Interest given a data set, reference year, and number of observations wanted for increasing or decreasing

Species_Greatest_Change <- function(data, ref_year, n) {                                                                                  #Create Function "Species_Greatest_Change"                                                                      
  data <- data %>%                                                                                                                        #Using inputted data set 
    filter(year >= ref_year & year != 2010) %>%                                                                                           #Keeps Data from Reference Year to Present (2009) excluding 2010 data
    group_by(year) %>%                                                                                                                    #Group Data by Year
    summarise(across(starts_with("N_"), mean, na.rm = TRUE))                                                                              #Mean Count of Each Species Caught (Columns Starting with N_) by Year
  
  species_cols <- names(data)[grepl("^N_", names(data))]                                                                                  # Identify species columns
  
  species_matrix <- data.frame(Species = species_cols, Change = numeric(length(species_cols)), Trend = character(length(species_cols)))   # Initialize species change data frame
  
                                                                                                                                          # Calculate change between first and last recorded year
  for (i in seq_along(species_cols)) {                                                                                                    # For loop ranging from each value in species_cols
    first_year_value <- data[[species_cols[i]]][1]                                                                                        #Identify the Starting Mean Count for Each Species by Ref Year
    last_year_value <- data[[species_cols[i]]][nrow(data)]                                                                                #Identify current (2009) Mean Count for Each Species
    
    species_matrix$Change[i] <- last_year_value - first_year_value                                                                        #Identify Difference from reference to final year 
    
    species_matrix$Trend[i] <- ifelse(species_matrix$Change[i] > 0, "Increasing", "Decreasing")                                           #Identify If Species are Increasing or Decreasing
  }
  
  # Get top n increasing
  top_increasing <- species_matrix %>%                                                                                                    #Create a DF Length n for top increasing species
    filter(Trend == "Increasing") %>%                                                                                                     #Filter by Increasing 
    arrange(desc(Change)) %>%                                                                                                             #Arrange in deciding Order
    head(n)                                                                                                                               #Only Pull top n species
  
  # Get top n decreasing
  top_decreasing <- species_matrix %>%                                                                                                    #Create a DF Length n for top decreasing species
    filter(Trend == "Decreasing") %>%                                                                                                     #Filter by Decreasing
    arrange(Change) %>%                                                                                                                   #Arrange in acceding Order
    head(n)                                                                                                                               #Only Pull top n species             
  
  return(list(Top_Increasing = top_increasing, Top_Decreasing = top_decreasing))                                                          #Return in list format the top n for both increasing and decreasing 
}

species = Species_Greatest_Change(dwh, 2000, 5)                                                                                           #Using Trawling Data and Year 2000 as Reference to obtain 5 the 5 most Increasing and Decreasing Species

#Change Species Names to Format Used by Long-line Data set

species_increased <- sub("^N_", "", species$Top_Increasing$Species)                                                                       #Remove the "N_" from the beginning of the species names for Top_Increasing    
species_increased <- gsub("_", " ", species_increased)                                                                                    #Replace the "_" with a Space for Top_Increasing
species_decreased <- sub("^N_", "", species$Top_Decreasing$Species)                                                                       #Remove the "N_" from the beginning of the species names for Top_Decreasing    
species_decreased <- gsub("_", " ", species_decreased)                                                                                    #Replace the "_" with a Space for Top_decreasing

#Print Names For Species of Intrest

print(species_increased)
print(species_decreased)
```

##Question 3.2:

# Using Longline Data From after the Oil Spill Can Any Conclusions be made about the Identified Species of Intrest

Using the list of Species Identified during the bottom trowing data set, the long line data set was filtered to only include the specie. From here a dataset with only 18 observations and three species where created. The sum of each of these species where shown below. The maximum number of times a species where seen was 12 however due to the use of long lines all observations showed a low catch for each observation.


```{r}
#Long line Data sets

species_of_intrest = c(species_decreased,species_increased)                                 #Create a column of species of interest by combining species_decreased and species_increased                   

station = read.csv("../Final_Project/station.csv")                                          #Import long-line station data set 
catch  = read.csv("../Final_Project/catch.csv")                                             #Import long-line catch data set

dwh_longline = left_join(catch,station,by = "STATIONKEY")                                   #Left Join the catch dataset and the station dataset by STATIONKEY (labeled dwh_longline)

Longline_Species_of_Intrest = dwh_longline %>% filter(TAXON %in% species_of_intrest)        #Filter dwh_longline by species of interest in the Taxon Variable

print(Longline_Species_of_Intrest)                                                          #Print Dataframe Created

species_counts <- Longline_Species_of_Intrest %>%                                           #Create A Count of each observation for each respective species
  count(TAXON)

print(species_counts)                                                                       #Print Count Dataframe


#NOTE: Due to low catch for each of the identified species no analysis could be run on these species of interest

```

##Question 4:

# Using Longline Data From after the Oil Spill Can Any Conclusions be made From That the spill affected Benthic Marine Biology

The top 4 species that where observed the most where selected to be observed. Using the start time variable the year was identified and a separate variable was created. From hear the mean number of observations was found for each year and Taxon group. This created a dataset with three variables and 72 observations. The mean of each years species are then plotted using ggplot. From the plot all species show some decrease from 2009 (year before the oil spill) and 2010 (year of the oil spill)

```{r}

dwh_longline = left_join(catch,station,by = "STATIONKEY")                                   #Left Join the catch data set and the station data set by STATIONKEY (labeled dwh_longline)

species_counts <- dwh_longline %>%                                                          #Identify the top 4 species observed in the long-line data set
  count(TAXON)%>%                                                                           #create a count variable for TAXON labeled (n)
  arrange(desc(n)) %>%                                                                      #Arrange in Descending Order
  head(4)                                                                                   #Take only the top 4 species

print(species_counts)                                                                       #print species_counts data frame

longline_max_species_list = species_counts$TAXON                                            #Create a variable for the species names

longline_top_species_seen <- dwh_longline %>%                                               #Using full long-line data (catch merged with station)
filter(TAXON %in% longline_max_species_list)                                                #Filter data by top species seen in the TAXON variable
longline_top_species_seen$year = substring(longline_top_species_seen$START_TIME,6,7)        #Retrieve the year component from the START_TIME string (position 6 and 7)

longline_top_species_seen <- longline_top_species_seen %>%                                  #create a new dataframe
  mutate(
    year = ifelse(as.numeric(year) < 25,                                                    #Using a if else if 
                            paste0("20", year),                                             #year was less than 25 a 20 was placed in front of the value
                            paste0("19", year))                                             #year was greater or equal than 25 a 19 was placed in front of the value
  )

mean_longline_top_species <- longline_top_species_seen %>%                                  #New dataframe was created
    group_by(year,TAXON) %>%                                                                #Grouping the Previous One by Year
    summarise(mean_number = mean(NUMBER, na.rm = TRUE))                                     #Mean number of species caught per year was then found for each species and for each year

mean_longline_top_species <- mean_longline_top_species %>%                                 
  mutate(year = as.numeric(year))                                                           #Ensure Year is Read as a Numeric Value


ggplot(mean_longline_top_species, aes(x = year, y = mean_number)) +                         #ggplot to plot mean caught on y against year in x
  geom_point() +                                                                            # Creates Scatter plot
  geom_line() +                                                                             # Add lines to the points
  facet_wrap(~ TAXON) +                                                                     # Separate plots by species (TAXON)
  labs(title = "Species Observations Over Time",                                            #Creates labels for X and Y Axis and Title
       x = "Year",
       y = "Mean Number Observed") +
  theme_minimal()

mean_longline_top_species <- mean_longline_top_species %>% 
  mutate(after_spill = ifelse(year >= 2010, 1, 0))                                         #Adds a binary flag for before or after or equal 2010

model = lm(mean_number ~ year + TAXON + after_spill   ,data = mean_longline_top_species)   #Fits a linear regression for mean number by year,Taxon, and after_spill

summary(model)                                                                             #Shows results of linear model
```

